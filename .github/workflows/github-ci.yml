name: ğŸ“š GitHub CI

on:
  push:
    branches:
      - 'main'
    paths:
      - 'src/**'
      - 'my-haskell-lib.cabal'
      - '.github/workflows/github-ci.yml'

jobs:
  get-build-tag:
    name: ğŸ§  Calculate Build Image Tag
    runs-on: ubuntu-latest
    outputs:
      BUILD_IMAGE_TAG: ${{ steps.hash.outputs.BUILD_IMAGE_TAG }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Calculate Cababl Freeze Hash
        id: hash
        run: |
          BUILD_IMAGE_TAG=$(sha256sum cabal.project.freeze | cut -c1-64)
          echo "BUILD_IMAGE_TAG=$BUILD_IMAGE_TAG" >> $GITHUB_ENV
          echo "BUILD_IMAGE_TAG=$BUILD_IMAGE_TAG" >> $GITHUB_OUTPUT

  generate-docs:
    name: ğŸ› ï¸ Generate Haddock Documentation
    runs-on: ubuntu-latest
    needs: get-build-tag
    container:
      image: ghcr.io/lmrco/haskell:${{ needs.get-build-tag.outputs.BUILD_IMAGE_TAG }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“š Build Haddock documentation
        run: |
          cabal haddock --haddock-html --haddock-hyperlink-source

      - name: ğŸ“‚ Copy generated docs
        run: |
          mkdir -p generated-docs
          DOCS_PATH=$(find dist-newstyle/build -type d -path "*/doc/html/*" -name my-haskell-lib | head -n 1)
          if [ -z "$DOCS_PATH" ]; then
            echo "âŒ Failed to locate generated docs"
            exit 1
          fi
          cp -r "$DOCS_PATH"/* generated-docs/

      - name: ğŸš€ Deploy Haddock Docs to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./generated-docs
          publish_branch: gh-pages
          destination_dir: ${{ github.ref_name }}